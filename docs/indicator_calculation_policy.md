# 株価指標の計算方針

## 概要

時系列分析（バックテストなど）で収益利回りなどの株価指標を計算する際の、統一的な計算方針を定める。特に、株式分割や増資などで発行済株式数が変動する場合の取り扱いを明確にすることを目的とする。

## 基本原則

過去のある時点 `t` における指標を計算する場合、その時点 `t` で投資家が入手可能だった情報のみを利用する。これにより、将来のデータを利用してしまう「ルックアヘッド・バイアス」を完全に排除する。

## 共通の計算前提

各株価指標を計算する上で共通となる前提と、日次で調整されるデータの算出方法を定義する。

1. **株価の取得**:
   * 計算対象日 `t` の**調整されていない、生の株価** (`RawClose`) を取得する。

2. **財務諸表の特定**:
   * 計算対象日 `t` までに公表された、**最も新しい決算情報**（決算短信など）を特定する。

3. **基準となる財務データの取得**:
   * 特定した決算情報から、以下の基準値を取得する。
      * `Equity` (純資産)
      * `Profit` (実績純利益)
      * `ForecastProfit` (当期予想純利益, FY決算以外)
      * `NextYearForecastProfit` (来期予想純利益, FY決算)
      * `ResultDividendPerShareAnnual` (実績配当)
      * `ForecastDividendPerShareAnnual` (当期予想配当, FY決算以外)
      * `NextYearForecastDividendPerShareAnnual` (来期予想配当, FY決算)
      * `TotalShares` (発行済株式数)
      * `TreasuryShares` (自己株式数)

4. **株式数の更新と流通株式数の算出**:
   * `daily_adjusted_shares.md` に記載されているロジックに基づき、日々の株価データに含まれる `AdjustmentFactor` を用いて、`TotalShares` (発行済株式数) と `TreasuryShares` (自己株式数) を日次で調整する。
   * これにより、各日 `t` における `AdjustedTotalShares` (調整後発行済株式数) と `AdjustedTreasuryShares` (調整後自己株式数) を算出する。
   * `流通株式数` = `AdjustedTotalShares` - `AdjustedTreasuryShares` の計算式で、当日 `t` 時点での有効な流通株式数を求める。この処理は、過去の基準値を現在の状態に合わせる「**更新**」と位置づける。

## 各指標の計算アルゴリズム

上記「共通の計算前提」で算出されたデータを用いて、各株価指標を計算する。

### 1. 純資産利回り (Book-value Yield)

企業の資産価値に対する株価の割安度を測る指標。PBRの逆数に相当する。

* **必要なデータ**:
  * 分子: `Equity` (純資産)
  * 分母: `流通株式数`、`RawClose`
* **計算式**:
  ```
  純資産利回り = Equity / (流通株式数 × RawClose)
  ```

### 2. 収益利回り (Earnings Yield)

企業の利益創出力を測る指標。PERの逆数に相当する。
（注: ここでいう「収益」は「純利益」を指します。）

* **収益利回りの種類**:
  * **実績収益利回り**: 実績純利益 (TTM) を用いて計算する。
  * **予想収益利回り**: 最新の決算情報に基づいて決定される予想純利益を用いて計算する。

* **実績純利益 (TTM) の決定方法**:
  * 収益利回りの計算には、**常に通期の純利益に相当する値**を用いる。
  * FY決算の場合は `Profit` (当期の実績純利益) を使用する。
  * FY決算以外 (1Q, 2Q, 3Q) の場合は、過去4四半期の `Profit` を合算して算出する。各四半期の純利益は累積値で提供されるため、`当期累積純利益 - 前期累積純利益` で当該四半期の純利益を算出し、過去4四半期分を合算する。

* **予想純利益の決定方法**:
  * 計算対象日 `t` において、以下の条件に基づき、使用する予想純利益を決定する。
    * もし最新の決算情報がFY決算であり、`NextYearForecastProfit` (来期の予想純利益) が存在する場合、**これを使用する**。
    * そうでなく、もし最新の決算情報がFY決決算以外 (1Q, 2Q, 3Q) であり、`ForecastProfit` (当期の予想純利益) が存在する場合、**これを使用する**。
    * 上記いずれの予想値も存在しない場合、予想純利益は算出しない。

* **計算式**:
  * **実績収益利回り**:
    ```
    実績収益利回り = (実績純利益 (TTM)) / (流通株式数 × RawClose)
    ```
  * **予想収益利回り**:
    ```
    予想収益利回り = (予想純利益) / (流通株式数 × RawClose)
    ```

### 3. 配当利回り (Dividend Yield)

株主への直接還元を測る指標。

* **必要なデータ**:
  * 分子: `年間配当総額`
  * 分母: `流通株式数`、`RawClose`
* **年間配当総額の算出方法**:
  * **実績配当**:
    * 配当利回りの計算には、**常に通期の配当総額に相当する値**を用いる。
    * **実績配当総額 (TTM) の決定方法**:
      * FY決算の場合は `ResultTotalDividendPaidAnnual` を使用する。
      * FY決算以外 (1Q, 2Q, 3Q) の場合は、直近12ヶ月の一株あたり配当実績 (TTM DPS) を算出し、`流通株式数` を乗じて年間配当総額とする。
        * TTM DPSは、過去4四半期の `ResultDividendPerShare1stQuarter`, `ResultDividendPerShare2ndQuarter`, `ResultDividendPerShare3rdQuarter`, `ResultDividendPerShareFiscalYearEnd` の該当する値を合算して算出する。
  * **予想配当**:
    * `financial_statements_schema.md` に記載の通り、`ForecastTotalDividendPaidAnnual` や `NextYearForecastTotalDividendAnnual` はデータが欠落しているか、カラム自体が存在しない。このため、以下の計算式で算出する。
      * `年間配当総額 = ForecastDividendPerShareAnnual × 流通株式数`
      * `年間配当総額 = NextYearForecastDividendPerShareAnnual × 流通株式数`
      * （注: `ForecastDividendPerShareAnnual` や `NextYearForecastDividendPerShareAnnual` が利用できない場合は、四半期ごとの配当予想を合算するなど、別途ロジックを検討する。）
* **計算式**:
  ```
  配当利回り = 年間配当総額 / (流通株式数 × RawClose)
  ```

## このアプローチの利点

* **企業行動の反映**: 新しい決算が公表されると、`TotalShares` (発行済株式数) や `TreasuryShares` (自己株式数) が更新されるため、増資、自己株式取得、株式償却などの企業行動が自然に反映される。
* **株式分割・併合の反映**: `AdjustmentFactor` を用いた日次調整により、株価と株式数の間の不整合を解消し、過去に遡って正確な流通株式数を維持する。
* **直感的な分かりやすさ**: すべての利回り指標が「高いほど良い（割安・高効率）」という統一された基準で評価可能となり、計算の意図が明確になる。
* **将来情報の排除**: 計算の各ステップで、その時点で入手不可能な将来のデータ（未来の決算、未来から見た調整後株価など）を利用しない。
