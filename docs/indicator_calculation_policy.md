# 株価指標の計算方針

## 概要

時系列分析（バックテストなど）でPERなどの株価指標を計算する際の、統一的な計算方針を定める。
特に、株式分割や増資などで発行済株式数が変動する場合の取り扱いを明確にすることを目的とする。

## 基本原則

過去のある時点 `t` における指標を計算する場合、その時点 `t` で投資家が入手可能だった情報のみを利用する。これにより、将来のデータを利用してしまう「ルックアヘッド・バイアス」を完全に排除する。

## PERの計算アルゴリズム

過去のある日 `t` のPERを計算する際のアルゴリズムは、以下の通りとする。

1.  **株価の取得**:
    *   計算対象日 `t` の**調整されていない、生の株価**を取得する。

2.  **財務諸表の特定**:
    *   計算対象日 `t` までに公表された、**最も新しい決算情報**（決算短信など）を特定する。

3.  **基準となる財務データの取得**:
    *   特定した決算情報から、以下の基準値を取得する。
        *   `基準純利益` (通期予想 or 通期実績)
        *   `基準発行済株式数`

4.  **発行済株式数の更新**:
    *   決算情報の基準日（例: 3月31日）から計算対象日 `t` までの間に発生した株式分割・併合をすべて洗い出す。
    *   累積の分割比率（`SplitRatio`）を計算する。（例: 2:1分割なら `2`）
    *   `更新後株式数 = 基準発行済株式数 * SplitRatio` の計算式で、当日 `t` 時点での有効な株式数を求める。この処理は、過去の基準値を現在の状態に合わせる「**更新**」と位置づける。

5.  **PERの最終計算**:
    *   以下の式でPERを算出する。
    ```
    PER = (生の株価) / (基準純利益 / 更新後株式数)
    ```

## このアプローチの利点

*   **増資等の反映**: 新しい決算が公表されると、`基準発行済株式数`が自動的に更新されるため、増資や自己株式取得の影響が自然に反映される。
*   **株式分割の反映**: 株価とEPSの分母（株式数）の間の不整合を、株式数を更新することで解消する。
*   **直感的な分かりやすさ**: 市場で実際に付いた「生の株価」を正とし、それに合わせて株式数を更新するため、計算の意図が明確になる。
*   **将来情報の排除**: 計算の各ステップで、その時点で入手不可能な将来のデータ（未来の決算、未来から見た調整後株価など）を利用しない。
