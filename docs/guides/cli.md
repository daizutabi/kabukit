# CLI の使い方

kabukit は、複数のソースからデータを取得するための、
コマンドラインインターフェース（CLI）を提供します。

現在サポートしているソースは以下の通りです。

- [J-Quants API](https://jpx-jquants.com/)
- [EDINET API](https://disclosure2dl.edinet-fsa.go.jp/guide/static/disclosure/WZEK0110.html)
<!-- - [TDnet](https://www.release.tdnet.info/inbs/I_main_00.html) -->

コマンド名は `kabu` です。このコマンドの役割は大きく分けて 3 つあります。

1. J-Quants API および EDINET API の認証情報を設定します。
   これにより、ノートブックなどで使うときに、認証について気にする必要が
   なくなります。
2. 各コマンドで銘柄コードや日付を引数に与えることで、最小限の
   ネットワークアクセスで各 API から情報を取得します。結果はすぐにターミナル
   に表示されるので、API との通信が正常であること、および、取得した情報が
   期待通りであることを迅速に確認できます。
3. `--all` オプションを指定することで、
   非同期並列通信によって、
   全銘柄・全期間分の情報を取得できます。
   取得した情報は、キャッシュディレクトリに保存されます。
   このキャッシュデータを使うことで、
   ノートブックなどで、分析をすぐに始められます。

以下のガイドでは、これらの特徴を順次説明していきます。

## 認証設定 (`auth`)

`kabu auth` コマンドは、以下の優先順位で認証情報を探索します。

1. コマンドラインオプション (例: `--mailaddress`)
2. 設定ファイル (例: `~/.config/kabukit/config.toml`)
3. 環境変数 (例: `JQUANTS_MAILADDRESS`)
4. 上記いずれにも見つからない場合は、インタラクティブな入力プロンプトを表示

### J-Quants API (`jquants`)

J-Quants API を利用するには、事前に
[ユーザー登録](https://jpx-jquants.com/auth/signup/?lang=ja)
が必要です。

`kabu auth jquants` コマンドで、
事前登録したメールアドレスとパスワードを使って認証を行い、
ID トークンを取得します。
取得した ID トークンは、設定ファイルに保存され、
あとから再利用されます。

#### 対話的な使い方

オプションを指定せずにコマンドを実行すると、メールアドレスとパスワードの入力を求められます。

```bash
$ kabu auth jquants
Mailaddress: my_email@example.com
Password:
J-QuantsのIDトークンを保存しました。
```

#### 非対話的な使い方

CI/CD 環境など、対話的な入力ができないときは、
コマンドラインオプションまたは環境変数で認証情報を指定できます。

- コマンドラインオプション

```bash
$ kabu auth jquants --mailaddress my_email@example.com --password my_password
```

- 環境変数

```bash
$ export JQUANTS_MAILADDRESS="my_email@example.com"
$ export JQUANTS_PASSWORD="my_password"
$ kabu auth jquants
```

### EDINET API (`edinet`)

EDINET API を利用するには、事前に
[API キーの取得](https://disclosure2dl.edinet-fsa.go.jp/guide/static/disclosure/download/ESE140206.pdf)
が必要です。

`kabu auth edinet` コマンドで API キーを設定ファイルに保存します。

#### 対話的な使い方

```bash
$ kabu auth edinet
Api key: my_api_key
EDINETのAPIキーを保存しました。
```

#### 非対話的な使い方

- コマンドラインオプション

```bash
$ kabu auth edinet --api-key my_api_key
```

- 環境変数

```bash
$ export EDINET_API_KEY="my_api_key"
```

!!! note
    環境変数を設定しているときは、別途
    `kabu auth edinet`コマンドを実行する
    必要はありません。

### 認証設定の表示 (`show`)

認証設定の保存先と内容は、`kabu auth show` コマンドで表示できます。

```bash
$ kabu auth show
設定ファイル: /home/my_name/.config/kabukit/config.toml
JQUANTS_ID_TOKEN = "..."
EDINET_API_KEY = "..."
```

## 情報取得 (`get`)

`kabu get` コマンドは、J-Quants API および EDINET API から各種情報を取得します。

### 上場銘柄一覧 (`info`)

`kabu get info` コマンドを使うと、
J-Quants API から上場銘柄一覧を取得します。

銘柄コード (4桁) を指定すると、指定した銘柄の最新情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get info 7203
```

日付 (YYYYMMDD) を指定すると、指定した日付または
翌営業日における全銘柄の情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get info 20230101
```

銘柄コードを省略すると、当日または翌営業日における全銘柄の最新情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get info
```

以下のオプションが設定可能です。

- `--quiet` または `-q` オプションを付けると、取得したデータフレームの表示を抑制できます。

銘柄コードまたは日付を指定したときは、表示されたデータフレームは保存されずに
プログラムは終了します。
単純に J-Quants API へのリクエストが正常に処理され、期待通りの情報が得られていることを
確認したいケースで用います。

一方、銘柄コードを省略したときは、
取得した上場銘柄一覧はキャッシュディレクトリに保存されます。
このキャッシュデータを使うことで、
ノートブックなどで、分析をすぐに始められます。

### 財務情報 (`statements`)

`kabu get statements` コマンドを使うと、
J-Quants API から財務情報を取得します。

銘柄コードを指定すると、指定した銘柄の全期間分の財務情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get statements 7203
```

日付を指定すると、指定した日付に
開示された全銘柄の財務情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get statements 20251023
```

引数を省略すると、当日に
開示された全銘柄の財務情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get statements
```

引数を省略して、`--all` オプションを付けると、
全銘柄の全期間分の財務情報を一度に取得できます。

```text
$ kabu get statements --all
100%|█████████████████████████████████████| 3787/3787 [01:28<00:00, 42.61it/s]
shape: (165_891, 105)
(略)
```

このようにプログレスバーが表示され、進捗状況が把握できるようになっています。
上の出力例から、次のことがわかります。

- 1 秒間に 40 銘柄程度の財務情報を取得しました。
- トータルで 1 分 30 秒程度かかりました。
- 取得したデータフレームの行数は約 16 万行です。

以下のオプションが設定可能です。

- `--max-items` オプションを付けると、銘柄数の上限を指定できます。
- `--quiet` または `-q` オプションを付けると、プログレスバーおよび
  取得したデータフレームの表示を抑制できます。

`--all` オプションを付け、かつ、`--max-items` オプションを付けないとき、
取得した財務情報はキャッシュディレクトリに保存されます。
このキャッシュデータを使うことで、
ノートブックなどで、分析をすぐに始められます。

### 株価情報 (`prices`)

`kabu get prices` コマンドを使うと、
J-Quants API から株価情報を取得します。

銘柄コードを指定すると、指定した銘柄の全期間分の株価情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get prices 7203
```

日付を指定すると、指定した日付の
全銘柄の株価情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get prices 20251023
```

引数を省略すると、当日の
全銘柄の株価情報を取得できます。

```console exec="1" source="1" result="text"
$ kabu get prices
```

引数を省略して、`--all` オプションを付けると、
全銘柄の全期間分の株価情報を一度に取得できます。

```text
$ kabu get prices --all
100%|█████████████████████████████████████| 3787/3787 [12:33<00:00,  5.02it/s]
shape: (8_128_217, 16)
(略)
```

このようにプログレスバーが表示され、進捗状況が把握できるようになっています。
上の出力例から、次のことがわかります。

- 1 秒間に 5 銘柄程度の株価情報を取得しました。
- トータルで 13 分程度かかりました。
- 取得したデータフレームの行数は約 8 百万行です。

以下のオプションが設定可能です。

- `--max-items` オプションを付けると、銘柄数の上限を指定できます。
- `--quiet` または `-q` オプションを付けると、プログレスバーおよび
  取得したデータフレームの表示を抑制できます。

`--all` オプションを付け、かつ、`--max-items` オプションを付けないとき、
取得した株価情報はキャッシュディレクトリに保存されます。

### J-Quants 情報の一括取得 (`jquants`)

これまで、J-Quantsが提供する 3 つの情報を、個別のコマンドで取得してきました。
`kabu get jquants` コマンドを使うと、全ての入手可能な情報を一度に取得できます。

```bash
$ kabu get jquants [arg]
```

- `arg` 引数で銘柄コードまたは日付を指定すると、指定した銘柄または日付に関する情報を取得します。
  省略すると、当日の情報を取得します。
- `--all` オプションを付けると、全銘柄の全期間分の情報を一度に取得します。
- `--max-items` オプションを付けると、全銘柄取得時の銘柄数の上限を指定できます。
- `--quiet` または `-q` オプションを付けると、プログレスバーおよび
  取得したデータフレームの表示を抑制できます。

`--all` オプションを付け、かつ、`--max-items` オプションを付けないとき、
取得した各種情報はキャッシュディレクトリに保存されます。

### EDINET 書類一覧 (`edinet`)

`kabu get edinet` コマンドを使うと、
EDINET API から提出書類一覧を取得します。

日付を指定すると、指定した日付に
提出された書類一覧を取得できます。

```console exec="1" source="1" result="text"
$ kabu get edinet 20251010
```

日付を指定しないと、当日に
提出された書類一覧を取得できます。

```console exec="1" source="1" result="text"
$ kabu get edinet
```

日付を指定せずに、`--all` オプションを付けると、
過去 10 年分の書類一覧を一度に取得できます。

```text
$ kabu get edinet --all
100%|█████████████████████████████████████| 3653/3653 [00:42<00:00, 86.47it/s]
shape: (896_632, 30)
(略)
```

このようにプログレスバーが表示され、進捗状況が把握できるようになっています。
上の出力例から、次のことがわかります。

- 1 秒間に 80 日程度の書類一覧を取得しました。
- トータルで 50 秒程度かかりました。
- 取得したデータフレームの行数は約 90 万行です。

以下のオプションが設定可能です。

- `--max-items` オプションを付けると、取得日数の上限を指定できます。
- `--quiet` または `-q` オプションを付けると、プログレスバーおよび
  取得したデータフレームの表示を抑制できます。

<!--
### TDnet 書類一覧 (`tdnet`)

`kabu get tdnet` コマンドを使うと、
TDnet から開示書類一覧を取得します。

日付を指定すると、指定した日付に
開示された書類一覧を取得できます。

```console exec="1" source="1" result="text"
$ kabu get tdnet 20251010
```

日付を指定しないと、当日に
開示された書類一覧を取得できます。

```console exec="1" source="1" result="text"
$ kabu get tdnet
```

日付を指定せずに、`--all` オプションを付けると、
過去 1 か月分の書類一覧を一度に取得できます。

```text
$ kabu get tdnet --all
100%|█████████████████████████████████████| 31/31 [00:01<00:00, 19.69it/s]
shape: (5_135, 9)
(略)
```

このようにプログレスバーが表示され、進捗状況が把握できるようになっています。
上の出力例から、次のことがわかります。

- 1 秒間に 20 日程度の書類一覧を取得しました。
- トータルで 1～2 秒程度かかりました。
- 取得したデータフレームの行数は約 5 千行です。

以下のオプションが設定可能です。

- `--max-items` オプションを付けると、取得日数の上限を指定できます。
- `--quiet` または `-q` オプションを付けると、プログレスバーおよび
  取得したデータフレームの表示を抑制できます。
-->

## キャッシュ (`cache`)

これまでに説明したように、取得した情報は
キャッシュディレクトリに保存されます。

`kabu cache` コマンドを使うと以下のことができます。

- `kabu cache tree`: キャッシュの内容をツリー表示します
- `kabu cache clean`: キャッシュの一部または全体を消去します

キャッシュの仕組みや、Python からの活用方法については、
[キャッシュの活用](cache.md)ガイドを参照してください。
