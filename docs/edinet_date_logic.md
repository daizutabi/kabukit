# EDINETデータの`Date`カラム決定ロジック

## 1. 課題

`kabukit`ライブラリが提供する`Date`カラムは、「その情報が株価に影響を与えうる日」を表現することを目的としている。

J-Quants APIには`DisclosedDate`および`DisclosedTime`フィールドが存在するため、`15:30`を市場の取引時間後の閾値（スレッショルド）として`Date`を計算するロジックは比較的単純である。

しかし、EDINET APIは`submitDateTime`（提出日時）しか提供しない。EDINETの仕様上、「提出」から「開示（利用者が閲覧可能になること）」までには未知のタイムラグが存在するため、「提出日時＝開示日時」とみなすことはできない。この不確実性の中で、いかにして信頼性のある`Date`を決定するかが課題である。

## 2. リスク分析

`Date`の計算ロジックを設計する上で、考慮すべきリスクは以下の通りである。

- **最も避けるべきリスク:** 本来は翌営業日の株価に影響する情報（例: 15:30以降に開示された情報）を、当日の情報として誤って分類してしまうこと。
- **許容されるリスク:** 本来は当日の情報として扱えるもの（例: 14:00に開示された情報）を、安全側に倒して翌営業日扱いとしてしまうこと。これは機会損失につながる可能性はあるが、誤った判断を誘発するよりは安全である。

結論として、設計は「本当は翌日扱いなのに当日扱いしてしまう」リスクを最小化する、**保守的な（conservative）**方針を取るべきである。

## 3. 解決策：安全マージンの導入

上記のリスク分析に基づき、以下のロジックで`Date`を決定する。

1. **開示の最終デッドラインを`15:30`と定義する。**
    これはJ-Quantsのロジックと一貫性を保つためである。この時刻までに開示された情報は、当日の株価に影響を与えうるとみなす。

2. **30分の「安全マージン」を設ける。**
    EDINETの「提出から開示までの未知のタイムラグ」を吸収するためのバッファとして、30分という安全マージンを設定する。

3. **提出時刻の閾値を`15:00`に設定する。**
    上記から逆算し、提出時刻 (`submitTime`) の閾値を `15:30（デッドライン） - 30分（安全マージン） = 15:00` とする。

### 最終的な計算ルール

- EDINETデータの`submitTime`が**15:00より前**の場合、`submitDate`を`Date`の基準日とする。
- EDINETデータの`submitTime`が**15:00以降**の場合、`submitDate`の**翌日**を`Date`の基準日とする。
- 上記で決定した基準日を、休日や週末だった場合に備えて**次の営業日までロールフォワード**する。

このロジックにより、不確実性を許容しつつ、最も合理的で防御可能な方法で`Date`カラムを導出することができる。
